@page "/settings"
@using GitHubIssueManager.Maui.Services
@inject AuthenticationService AuthService
@rendermode InteractiveServer

<PageTitle>Settings</PageTitle>

<MudText Typo="Typo.h3" GutterBottom="true">Settings</MudText>

<MudGrid>
    <MudItem xs="12" md="8">
        <MudCard>
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">GitHub Authentication</MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                @if (AuthService.IsAuthenticated)
                {
                    <MudAlert Severity="Severity.Success" Class="mb-4">
                        <MudText>
                            <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Class="mr-2" />
                            GitHub token is configured and active.
                        </MudText>
                    </MudAlert>
                    <MudButton Variant="Variant.Outlined" 
                              Color="Color.Error" 
                              StartIcon="@Icons.Material.Filled.Clear"
                              OnClick="ClearToken">
                        Clear Token
                    </MudButton>
                }
                else
                {
                    <MudAlert Severity="Severity.Warning" Class="mb-4">
                        <MudText>
                            <MudIcon Icon="@Icons.Material.Filled.Warning" Class="mr-2" />
                            No GitHub token configured.
                        </MudText>
                    </MudAlert>
                    
                    <MudTextField @bind-Value="tokenInput" 
                                  Label="GitHub Personal Access Token" 
                                  Variant="Variant.Outlined" 
                                  InputType="InputType.Password"
                                  HelperText="Your token will be stored locally and used to authenticate with the GitHub API."
                                  Class="mb-4"
                                  FullWidth="true" />
                    
                    <MudButton Variant="Variant.Filled" 
                              Color="Color.Primary" 
                              StartIcon="@Icons.Material.Filled.Save"
                              OnClick="SaveToken" 
                              Disabled="@string.IsNullOrWhiteSpace(tokenInput)">
                        Save Token
                    </MudButton>
                }
                
                <MudDivider Class="my-6" />
                
                <MudText Typo="Typo.h6" Class="mb-3">How to create a GitHub Personal Access Token:</MudText>
                <MudText Typo="Typo.body2">
                    <ol>
                        <li class="mb-2">
                            Go to <MudLink Href="https://github.com/settings/tokens" Target="_blank" Color="Color.Primary">
                                GitHub Settings → Developer settings → Personal access tokens
                            </MudLink>
                        </li>
                        <li class="mb-2">Click "Generate new token" → "Generate new token (classic)"</li>
                        <li class="mb-2">Give it a descriptive name like "GitHub Issue Manager"</li>
                        <li class="mb-2">
                            Select the following scopes:
                            <ul class="mt-2">
                                <li><MudText Typo="Typo.body2" Color="Color.Secondary">repo</MudText> - Full control of private repositories</li>
                                <li><MudText Typo="Typo.body2" Color="Color.Secondary">public_repo</MudText> - Access public repositories</li>
                                <li><MudText Typo="Typo.body2" Color="Color.Secondary">user</MudText> - Read user profile data</li>
                            </ul>
                        </li>
                        <li class="mb-2">Click "Generate token" and copy the token value</li>
                        <li>Paste the token in the field above and click "Save Token"</li>
                    </ol>
                </MudText>
                
                <MudAlert Severity="Severity.Info" Class="mt-4">
                    <MudText>
                        <strong>Security Note:</strong> Your token is stored locally on your device and is only used to communicate with the GitHub API. Never share your personal access token with others.
                    </MudText>
                </MudAlert>
            </MudCardContent>
        </MudCard>
    </MudItem>
</MudGrid>

@code {
    private string tokenInput = string.Empty;

    private void SaveToken()
    {
        if (!string.IsNullOrWhiteSpace(tokenInput))
        {
            AuthService.SetToken(tokenInput);
            tokenInput = string.Empty;
            StateHasChanged();
        }
    }

    private void ClearToken()
    {
        AuthService.ClearToken();
        StateHasChanged();
    }
}